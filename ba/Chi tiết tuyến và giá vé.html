<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chi tiết tuyến & giá vé - Nhà Xe Thăng Long</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root {
      --primary: #4361ee;
      --sidebar-bg: #0f0f1a;
      --sidebar-hover: #1e1e2e;
      --text-light: #cbd5e1;
      --border-radius: 20px;
      --green: #10b981;
      --blue: #3b82f6;
      --yellow: #f59e0b;
      --red: #ef4444;
      --orange: #fb923c;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
    body { background:#f8fafc; color:#333; display:flex; min-height:100vh; }

    .sidebar {
      width:280px; background:var(--sidebar-bg); color:white; padding:30px 20px;
      position:fixed; height:100vh; overflow-y:auto;
      border-radius:0 var(--border-radius) var(--border-radius) 0;
      box-shadow:8px 0 30px rgba(0,0,0,0.4); z-index:1000;
    }
    .user-info { display:flex; align-items:center; gap:14px; padding-bottom:24px;
      border-bottom:1px solid #2d2d44; margin-bottom:30px; }
    .user-info img { width:52px; height:52px; border-radius:50%; object-fit:cover; border:3px solid #374151; }
    .user-info .info h3 { font-size:17px; font-weight:600; margin-bottom:4px; }
    .user-info .info p { font-size:13px; color:#94a3b8; }
    .menu-title { text-transform:uppercase; font-size:11px; color:#64748b; letter-spacing:1.5px;
      margin:20px 0 12px; font-weight:600; }
    .menu { list-style:none; }
    .menu a {
      display:flex; align-items:center; gap:14px; padding:14px 18px; color:#94a3b8;
      text-decoration:none; border-radius:14px; transition:all .3s; font-size:15px; font-weight:500;
    }
    .menu a i { font-size:18px; width:24px; text-align:center; }
    .menu a:hover { background:var(--sidebar-hover); color:white; }
    .menu a.active { background:white !important; color:var(--primary) !important;
      font-weight:600; box-shadow:0 6px 20px rgba(67,97,238,.25); }
    .menu a.active i { color:var(--primary) !important; }

    .main-content { flex:1; margin-left:280px; padding:30px; background:#f1f5f9; min-height:100vh; }
    .top-bar {
      background:white; padding:20px 30px; border-radius:var(--border-radius);
      box-shadow:0 4px 20px rgba(0,0,0,.06); display:flex; justify-content:space-between;
      align-items:center; margin-bottom:18px;
    }
    .greeting { font-size:18px; font-weight:500; }
    .greeting span { color:#94a3b8; font-size:16px; }
    .notification { position:relative; width:40px; height:40px; background:#f1f5f9;
      border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .notification .badge { position:absolute; top:-4px; right:-4px; background:#ef4444;
      color:white; font-size:10px; width:18px; height:18px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; }

    .back-btn { display:flex; align-items:center; gap:8px; color:#64748b;
      font-size:16px; margin-bottom:14px; cursor:pointer; }

    .page-title { font-size:24px; font-weight:800; color:#1e293b; margin-bottom:10px; }

    .sub-links { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      background:white; border:1px solid #e2e8f0;
      cursor:pointer; transition:.2s; font-weight:700; color:#334155;
    }
    .chip:hover { background:#eef2ff; border-color:#c7d2fe; color:#1e40af; }
    .chip.active { background:var(--primary); color:white; border-color:var(--primary); cursor:default; }
    .chip i { opacity:.9; }

    .action-buttons { display:flex; gap:12px; margin-bottom:18px; justify-content:flex-end; flex-wrap:wrap; }
    .btn { padding:10px 20px; border-radius:12px; font-size:14px; font-weight:700;
      cursor:pointer; display:flex; align-items:center; gap:8px; transition:.3s; border:none; }
    .btn:hover { opacity:0.92; }
    .btn-refresh { background:#e0e7ff; color:var(--primary); border:1px solid #c7d2fe; }
    .btn-edit { background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
    .btn-delete { background:#fee2e2; color:#dc2626; border:1px solid #fca5a5; }
    .btn-secondary { background:#e2e8f0; color:#475569; border:1px solid #cbd5e1; }

    /* Giữ CSS alert-box nhưng HTML không dùng */
    .alert-box {
      background:#fef3c7; border-left:4px solid #f59e0b; padding:16px; border-radius:8px;
      margin-bottom:20px; display:flex; align-items:center; gap:12px; color:#92400e; font-weight:600;
    }
    .alert-danger { background:#fee2e2; border-left:4px solid var(--red); color:#991b1b; }

    .info-grid {
      display:grid; grid-template-columns:1fr 1fr; gap:30px; background:white;
      padding:24px; border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,.05); margin-bottom:20px;
    }
    .info-item { display:flex; justify-content:space-between; padding:12px 0;
      border-bottom:1px solid #f1f5f9; gap:14px; }
    .info-item:last-child { border-bottom:none; }
    .info-item strong { color:#475569; text-align:right; }
    .status-badge { padding:6px 14px; border-radius:30px; font-size:13px; font-weight:800; white-space:nowrap; display:inline-flex; align-items:center; gap:8px; }

    .stats-summary { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:20px; }
    .stat-box { background:white; padding:18px; border-radius:16px; text-align:center;
      box-shadow:0 4px 15px rgba(0,0,0,.05); }
    .stat-box h3 { font-size:22px; font-weight:900; margin-bottom:8px; }
    .stat-box.ready h3 { color:var(--green); }
    .stat-box.warning h3 { color:var(--yellow); }
    .stat-box.over h3 { color:var(--red); }
    .stat-box.total h3 { color:var(--primary); }

    .tab-buttons { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; }
    .tab-btn {
      padding:10px 20px; background:#e2e8f0; border-radius:12px; font-weight:800;
      cursor:pointer; transition:all .2s;
    }
    .tab-btn.active { background:var(--primary); color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:12px 16px; text-align:left; border-bottom:1px solid #f1f5f9; vertical-align:top; }
    th { background:#f8fafc; color:#475569; font-weight:800; }
    .btn-small { padding:6px 10px; font-size:12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }

    .filters {
      display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px;
      background:#f8fafc; padding:12px; border-radius:12px; border:1px solid #e2e8f0;
    }
    .filter-item { display:flex; flex-direction:column; gap:6px; min-width:180px; flex:1; }
    .filter-item label { font-size:12px; color:#64748b; font-weight:800; }
    .filter-item select, .filter-item input {
      padding:10px 12px; border-radius:10px; border:1px solid #e2e8f0; background:white;
      font-size:14px;
    }

    .right-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }
    .hint { margin-top:8px; color:#64748b; font-size:13px; line-height:1.5; }

    .two-col { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .mini-card { background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:14px; }
    .mini-title { display:flex; align-items:center; gap:10px; font-weight:900; color:#0f172a; margin-bottom:8px; }
    .mini-card ul { padding-left:18px; color:#334155; }
    .mini-card li { margin:6px 0; }

    .link-a { color:#1e40af; font-weight:900; text-decoration:none; cursor:pointer; }
    .link-a:hover { text-decoration:underline; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; z-index:9999; }
    .modal.active { display:flex; }
    .modal-content { background:white; width:90%; max-width:820px; border-radius:16px;
      overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:zoom .3s; }
    @keyframes zoom { from{transform:scale(0.92);opacity:0} to{transform:scale(1);opacity:1} }
    .modal-header { padding:20px; background:var(--primary); color:white; font-size:18px;
      font-weight:900; display:flex; justify-content:space-between; align-items:center; }
    .modal-header.danger { background:var(--red); }
    .modal-body { padding:22px 24px; max-height:72vh; overflow-y:auto; }
    .modal-footer { padding:16px 24px; background:#f8fafc; display:flex; gap:12px;
      justify-content:flex-end; flex-wrap:wrap; }
    .form-group { margin-bottom:16px; }
    .form-group label { display:block; margin-bottom:8px; font-weight:800; color:#374151; }
    .form-group label span.required { color:var(--red); }
    .form-group input, .form-group select, .form-group textarea {
      width:100%; padding:12px 16px; border:1px solid #e2e8f0; border-radius:12px; font-size:14px;
    }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .btn-modal { padding:10px 24px; border:none; border-radius:12px; cursor:pointer; font-weight:900; }
    .btn-modal-primary { background:var(--primary); color:white; }
    .btn-modal-danger { background:var(--red); color:white; }
    .btn-modal-secondary { background:#e2e8f0; color:#475569; }

    /* Toast */
    .toast-wrap{position:fixed;top:18px;right:18px;z-index:10000;display:flex;flex-direction:column;gap:10px;}
    .toast{
      background:#0f172a;color:white;border-radius:14px;padding:12px 14px;min-width:280px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;gap:10px;align-items:flex-start;
    }
    .toast i{margin-top:2px;}
    .toast .t-title{font-weight:900;margin-bottom:2px;}
    .toast .t-desc{color:#cbd5e1;font-size:13px;line-height:1.35;}
    .toast.success{background:#052e16;}
    .toast.danger{background:#450a0a;}
    .toast.info{background:#0b1b4b;}

    /* Log modal table nicer */
    .badge-chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0;
      font-weight:800;color:#334155;font-size:12px;
    }
    .empty{
      padding:14px;border:1px dashed #cbd5e1;border-radius:14px;color:#64748b;background:#fff;
    }

    @media (max-width:992px) {
      .sidebar { width:80px; padding:20px 10px; }
      .sidebar .user-info .info, .sidebar .menu-title, .sidebar .menu a span { display:none; }
      .sidebar a { justify-content:center; }
      .main-content { margin-left:80px; }
      .info-grid, .stats-summary, .form-row, .two-col { grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="user-info">
      <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Samantha">
      <div class="info">
        <h3>Samantha</h3>
        <p>+098 (99) 439-49-16</p>
      </div>
    </div>
    <p class="menu-title">MAIN MENU</p>
    <ul class="menu">
      <li><a href="#"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fas fa-car"></i> <span>Đặt xe</span></a></li>
      <li><a href="#"><i class="fas fa-car-side"></i> <span>Quản lý thông tin xe</span></a></li>
      <li><a href="#"><i class="fas fa-user-tie"></i> <span>Quản lý tài xế</span></a></li>
      <li><a href="#"><i class="fas fa-users"></i> <span>Quản lý tài khoản</span></a></li>
      <li><a href="#" class="active"><i class="fas fa-map-marked-alt"></i> <span>Quản lý tuyến & giá vé</span></a></li>
      <li><a href="#"><i class="fas fa-clock"></i> <span>Phân xe tự động</span></a></li>
      <li><a href="#"><i class="fas fa-cog"></i> <span>Cài đặt</span></a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="top-bar">
      <div class="greeting">Chào buổi sáng, Samantha <span>bạn có 2 thông báo mới</span></div>
      <div class="notification">
        <i class="fas fa-bell" style="font-size:18px;color:#64748b;"></i>
        <div class="badge">2</div>
      </div>
    </div>

    <div class="back-btn" onclick="goBackToList()">
      <i class="fas fa-arrow-left"></i> Quay lại danh sách tuyến
    </div>

    <div class="page-title" id="pageTitle">Chi tiết tuyến & giá vé • —</div>

    <div class="sub-links" id="relatedRoutes"></div>

    <div class="action-buttons">
      <button class="btn btn-secondary" onclick="openDeleteLogModal()">
        <i class="fas fa-file-lines"></i> Log xóa tuyến
      </button>
      <button class="btn btn-refresh" onclick="openModal('routeStatusModal')">
        <i class="fas fa-sync-alt"></i> Cập nhật trạng thái
      </button>
      <button class="btn btn-edit" onclick="openEditRouteModal()">
        <i class="fas fa-pen"></i> Chỉnh sửa tuyến
      </button>
      <button class="btn btn-delete" onclick="openModal('routeDeleteModal')">
        <i class="fas fa-trash-alt"></i> Xóa tuyến
      </button>
    </div>

    <!-- ✅ KHÔNG có thanh “Lưu ý” màu vàng -->

    <div class="info-grid">
      <div>
        <h3 style="margin-bottom:20px;color:#1e293b;font-size:18px;">Thông tin tuyến</h3>
        <div class="info-item"><span>Mã tuyến</span> <strong id="routeCode">—</strong></div>
        <div class="info-item"><span>Điểm đi</span> <strong id="routeFrom">—</strong></div>
        <div class="info-item"><span>Điểm đến</span> <strong id="routeTo">—</strong></div>
        <div class="info-item"><span>Khoảng cách</span> <strong id="routeDistance">—</strong></div>
        <div class="info-item"><span>Thời gian dự kiến</span> <strong id="routeDuration">—</strong></div>
      </div>

      <div>
        <div style="height:32px;"></div>
        <div class="info-item"><span>Loại xe khai thác</span> <strong id="routeVehicleMix">—</strong></div>
        <div class="info-item"><span>Chính sách hoàn/đổi</span> <strong id="routePolicy">—</strong></div>
        <div class="info-item"><span>Ngày cập nhật gần nhất</span> <strong id="routeUpdatedAt">—</strong></div>
        <div class="info-item"><span>Trạng thái</span>
          <span class="status-badge" id="routeStatusBadge">—</span>
        </div>
      </div>
    </div>

    <div class="stats-summary">
      <div class="stat-box total"><h3 id="stTripsMonth">—</h3><p>Chuyến / tháng (ước tính)</p></div>
      <div class="stat-box ready"><h3 id="stMinPrice">—</h3><p>Giá thấp nhất</p></div>
      <div class="stat-box warning"><h3 id="stMaxPrice">—</h3><p>Giá cao nhất</p></div>
      <div class="stat-box over"><h3 id="stDuration">—</h3><p>Thời gian dự kiến</p></div>
    </div>

    <div class="tab-buttons">
      <div class="tab-btn active" data-tab="tab-fares">Bảng giá vé</div>
      <div class="tab-btn" data-tab="tab-trips">Khung giờ chạy</div>
      <div class="tab-btn" data-tab="tab-stops">Điểm đón/trả</div>
    </div>

    <!-- TAB 1 -->
    <div id="tab-fares" class="tab-content active">
      <div style="background:white;padding:24px;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.05);">
        <h3 style="margin-bottom:14px;font-size:18px;color:#1e293b;">
          <i class="fas fa-tags"></i> Bảng giá vé theo loại xe
        </h3>

        <div class="filters">
          <div class="filter-item">
            <label>Loại xe</label>
            <select id="fareFilterVehicle">
              <option value="all" selected>Tất cả</option>
              <option value="Limousine">Limousine</option>
              <option value="Xe khách">Xe khách</option>
            </select>
          </div>
          <div class="filter-item">
            <label>Ngày áp dụng</label>
            <input id="fareFilterDate" type="date" />
          </div>
          <div class="filter-item">
            <label>Tìm nhanh</label>
            <input id="fareFilterQ" type="text" placeholder="Ví dụ: lễ/Tết, phụ thu..." />
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Loại xe</th>
              <th>Mức giá</th>
              <th>Phụ thu/Ghi chú</th>
              <th>Áp dụng từ</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="fareTbody"></tbody>
        </table>

        <div class="right-actions">
          <button class="btn btn-refresh" onclick="openAddFareModal()">
            <i class="fas fa-plus"></i> Thêm mức giá
          </button>
        </div>

        <div class="hint">
          Lọc theo ngày sẽ hiển thị các mức giá có ngày áp dụng ≤ ngày chọn.
        </div>
      </div>
    </div>

    <!-- TAB 2 -->
    <div id="tab-trips" class="tab-content">
      <div style="background:white;padding:24px;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.05);">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <h3 style="margin-bottom:10px;font-size:18px;color:#1e293b;">
            <i class="fas fa-clock"></i> Khung giờ chạy (theo tuyến)
          </h3>
          <button class="btn btn-refresh" onclick="openAddTripModal()">
            <i class="fas fa-plus"></i> Thêm chuyến
          </button>
        </div>

        <div class="filters">
          <div class="filter-item">
            <label>Loại xe</label>
            <select id="tripFilterVehicle">
              <option value="all" selected>Tất cả</option>
              <option value="Xe khách">Xe khách</option>
              <option value="Limousine">Limousine</option>
            </select>
          </div>
          <div class="filter-item">
            <label>Giờ xuất bến từ</label>
            <input id="tripFilterFromTime" type="time" />
          </div>
          <div class="filter-item">
            <label>Đến</label>
            <input id="tripFilterToTime" type="time" />
          </div>
          <div class="filter-item">
            <label>Tìm ghi chú</label>
            <input id="tripFilterQ" type="text" placeholder="Ví dụ: cao điểm, đón thêm..." />
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Tuyến</th>
              <th>Giờ xuất bến</th>
              <th>Giờ dự kiến đến</th>
              <th>Loại xe</th>
              <th>Trạng thái</th>
              <th>Ghi chú</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="tripTbody"></tbody>
        </table>

        <div class="hint">
          Chuyến được lưu theo tuyến trong localStorage.
        </div>
      </div>
    </div>

    <!-- TAB 3 -->
    <div id="tab-stops" class="tab-content">
      <div style="background:white;padding:24px;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.05);">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <h3 style="margin-bottom:10px;font-size:18px;color:#1e293b;">
            <i class="fas fa-map-pin"></i> Điểm đón / trả theo loại xe
          </h3>
          <button class="btn btn-refresh" onclick="openEditStopsModal()">
            <i class="fas fa-pen"></i> Cập nhật điểm đón/trả
          </button>
        </div>

        <div class="two-col">
          <div class="mini-card">
            <div class="mini-title">
              <span class="status-badge" style="background:#dcfce7;color:#166534;"><i class="fas fa-bus"></i> Xe khách</span>
              Điểm đón
            </div>
            <ul id="busPickupList"></ul>
          </div>
          <div class="mini-card">
            <div class="mini-title">
              <span class="status-badge" style="background:#dcfce7;color:#166534;"><i class="fas fa-bus"></i> Xe khách</span>
              Điểm trả
            </div>
            <ul id="busDropoffList"></ul>
          </div>
          <div class="mini-card">
            <div class="mini-title">
              <span class="status-badge" style="background:#e0e7ff;color:var(--primary);"><i class="fas fa-van-shuttle"></i> Limousine</span>
              Điểm đón
            </div>
            <ul id="limoPickupList"></ul>
          </div>
          <div class="mini-card">
            <div class="mini-title">
              <span class="status-badge" style="background:#e0e7ff;color:var(--primary);"><i class="fas fa-van-shuttle"></i> Limousine</span>
              Điểm trả
            </div>
            <ul id="limoDropoffList"></ul>
          </div>
        </div>

        <div class="hint">
          Xe khách: đón/trả tại bến. Limousine: đón/trả tận nơi (có thể cấu hình thêm).
        </div>
      </div>
    </div>
  </main>

  <!-- MODAL: CẬP NHẬT TRẠNG THÁI -->
  <div id="routeStatusModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-sync-alt"></i> Cập nhật trạng thái tuyến</span>
        <i class="fas fa-times" onclick="closeModal('routeStatusModal')" style="cursor:pointer;"></i>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Trạng thái mới</label>
          <select id="routeStatusSelect">
            <option>Đang khai thác</option>
            <option>Tạm ngưng</option>
            <option>Bảo trì tuyến</option>
            <option>Ngừng khai thác</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ghi chú (tuỳ chọn)</label>
          <textarea id="routeStatusNote" rows="3" placeholder="Ví dụ: tạm ngưng do điều tiết giao thông..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" onclick="closeModal('routeStatusModal')">Hủy</button>
        <button class="btn-modal btn-modal-primary" onclick="saveRouteStatus()">Lưu thay đổi</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CHỈNH SỬA TUYẾN -->
  <div id="routeEditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-pen"></i> Chỉnh sửa thông tin tuyến</span>
        <i class="fas fa-times" onclick="closeModal('routeEditModal')" style="cursor:pointer;"></i>
      </div>

      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Mã tuyến</label>
            <input id="m_routeCode" type="text" readonly style="background:#f1f5f9;">
          </div>
          <div class="form-group">
            <label>Trạng thái</label>
            <select id="m_routeStatus">
              <option>Đang khai thác</option>
              <option>Tạm ngưng</option>
              <option>Bảo trì tuyến</option>
              <option>Ngừng khai thác</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Điểm đi <span class="required">*</span></label>
            <input id="m_routeFrom" type="text" required>
          </div>
          <div class="form-group">
            <label>Điểm đến <span class="required">*</span></label>
            <input id="m_routeTo" type="text" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Khoảng cách (km)</label>
            <input id="m_routeDistance" type="number" min="1">
          </div>
          <div class="form-group">
            <label>Thời gian dự kiến (hh:mm) <span class="required">*</span></label>
            <input id="m_routeDuration" type="text" placeholder="02:30" required>
          </div>
        </div>

        <div class="form-group">
          <label>Chính sách hoàn/đổi</label>
          <input id="m_routePolicy" type="text" placeholder="Trước giờ chạy ≥ 2h">
        </div>

        <div class="form-group">
          <label>Ghi chú nội bộ (không hiển thị banner)</label>
          <textarea id="m_routeAlert" rows="3" placeholder="Ví dụ: Điều chỉnh giá áp dụng từ..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" onclick="closeModal('routeEditModal')">Hủy</button>
        <button class="btn-modal btn-modal-primary" onclick="saveRouteInfo()">Lưu thay đổi</button>
      </div>
    </div>
  </div>

  <!-- MODAL: THÊM/SỬA MỨC GIÁ -->
  <div id="fareModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-tags"></i> <span id="fareModalTitle">Thêm mức giá</span></span>
        <i class="fas fa-times" onclick="closeModal('fareModal')" style="cursor:pointer;"></i>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Loại xe <span class="required">*</span></label>
            <select id="m_fareVehicle">
              <option>Limousine</option>
              <option>Xe khách</option>
            </select>
          </div>
          <div class="form-group">
            <label>Giá niêm yết (đ) <span class="required">*</span></label>
            <input id="m_farePrice" type="number" min="0" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Áp dụng từ <span class="required">*</span></label>
            <input id="m_fareFrom" type="date" required>
          </div>
          <div class="form-group">
            <label>Ghi chú/Phụ thu</label>
            <input id="m_fareNote" type="text" placeholder="Ví dụ: +10.000đ lễ/Tết">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" onclick="closeModal('fareModal')">Hủy</button>
        <button class="btn-modal btn-modal-primary" onclick="submitFare()">Lưu</button>
      </div>
    </div>
  </div>

  <!-- MODAL: THÊM/SỬA CHUYẾN -->
  <div id="tripModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-clock"></i> <span id="tripModalTitle">Thêm chuyến</span></span>
        <i class="fas fa-times" onclick="closeModal('tripModal')" style="cursor:pointer;"></i>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Giờ xuất bến <span class="required">*</span></label>
            <input id="m_tripDepart" type="time" required>
          </div>
          <div class="form-group">
            <label>Giờ dự kiến đến <span class="required">*</span></label>
            <input id="m_tripArrive" type="time" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Loại xe <span class="required">*</span></label>
            <select id="m_tripVehicle">
              <option>Xe khách</option>
              <option>Limousine</option>
            </select>
          </div>
          <div class="form-group">
            <label>Trạng thái</label>
            <select id="m_tripStatus">
              <option>Đang mở bán</option>
              <option>Tạm dừng bán</option>
              <option>Hết chỗ</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Ghi chú</label>
          <textarea id="m_tripNote" rows="3" placeholder="Ví dụ: giờ cao điểm, đón thêm tại..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" onclick="closeModal('tripModal')">Hủy</button>
        <button class="btn-modal btn-modal-primary" onclick="submitTrip()">Lưu</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CẬP NHẬT ĐIỂM ĐÓN/TRẢ -->
  <div id="stopsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-map-pin"></i> Cập nhật điểm đón/trả</span>
        <i class="fas fa-times" onclick="closeModal('stopsModal')" style="cursor:pointer;"></i>
      </div>
      <div class="modal-body">
        <div class="hint" style="margin-bottom:12px;">
          Nhập mỗi điểm một dòng. Bỏ trống sẽ dùng mặc định.
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Xe khách • Điểm đón</label>
            <textarea id="m_busPickup" rows="5"></textarea>
          </div>
          <div class="form-group">
            <label>Xe khách • Điểm trả</label>
            <textarea id="m_busDropoff" rows="5"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Limousine • Điểm đón</label>
            <textarea id="m_limoPickup" rows="5"></textarea>
          </div>
          <div class="form-group">
            <label>Limousine • Điểm trả</label>
            <textarea id="m_limoDropoff" rows="5"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" onclick="closeModal('stopsModal')">Hủy</button>
        <button class="btn-modal btn-modal-primary" onclick="saveStops()">Lưu</button>
      </div>
    </div>
  </div>

  <!-- MODAL: XÓA TUYẾN -->
  <div id="routeDeleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header danger">
        <span><i class="fas fa-trash-alt"></i> Xóa tuyến</span>
        <i class="fas fa-times" onclick="closeModal('routeDeleteModal')" style="cursor:pointer;"></i>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn <strong>xóa tuyến</strong> <strong id="deleteRouteName">—</strong>?</p>
        <p style="color:#dc2626;margin:12px 0;font-weight:800;">Hành động này không thể hoàn tác!</p>
        <div class="form-group">
          <label>Lý do xóa <span style="color:red;">*</span></label>
          <textarea id="deleteReason" rows="3" placeholder="Nhập lý do bắt buộc"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-secondary" onclick="closeModal('routeDeleteModal')">Hủy</button>
        <button class="btn-modal btn-modal-danger" onclick="deleteRoute()">Xóa tuyến</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOG XÓA TUYẾN -->
  <div id="deleteLogModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-file-lines"></i> Log xóa tuyến (theo dõi thay đổi)</span>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn btn-secondary" style="padding:8px 12px;" onclick="clearDeleteLogs()">
            <i class="fas fa-broom"></i> Xóa log
          </button>
          <i class="fas fa-times" onclick="closeModal('deleteLogModal')" style="cursor:pointer;"></i>
        </div>
      </div>

      <div class="modal-body">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <div style="font-weight:900;color:#0f172a;">Danh sách tuyến đã bị xóa</div>
          <span class="badge-chip" id="logCountChip"><i class="fas fa-database"></i> 0 bản ghi</span>
        </div>

        <div class="filters" style="background:#fff;">
          <div class="filter-item">
            <label>Tìm trong log</label>
            <input id="logQ" type="text" placeholder="Mã tuyến / điểm đi-đến / người xóa..." oninput="renderDeleteLogs()">
          </div>
          <div class="filter-item">
            <label>Từ ngày</label>
            <input id="logFrom" type="date" oninput="renderDeleteLogs()">
          </div>
          <div class="filter-item">
            <label>Đến ngày</label>
            <input id="logTo" type="date" oninput="renderDeleteLogs()">
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Tuyến</th>
              <th>Mã tuyến</th>
              <th>Lý do xóa</th>
              <th>Người thao tác</th>
            </tr>
          </thead>
          <tbody id="logTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap"></div>

  <script>
    /* =========================
       0) KEYS (đồng bộ với màn list đã sửa)
       ========================= */
    const LS_ROUTES_KEY = "thanglong_routes_v2";              // từ màn danh sách
    const LS_DETAIL_KEY = "TL_ROUTE_DETAIL_V1";               // chi tiết: fares/trips/stops
    const LS_DELETE_LOG_KEY = "thanglong_routes_delete_log_v1";// log xóa tuyến (dùng chung)
    const CURRENT_USER = { name: "Samantha", role: "Dispatcher" }; // demo

    let routes = [];
    let currentRoute = null;
    let detailMap = {};
    let editingFareId = null;
    let editingTripId = null;

    function openModal(id){ document.getElementById(id).classList.add("active"); }
    function closeModal(id){ document.getElementById(id).classList.remove("active"); }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    /* =========================
       1) HELPERS
       ========================= */
    function toast(title, desc, type="info"){
      const wrap = document.getElementById("toastWrap");
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `
        <i class="fas ${type==="success"?"fa-circle-check":type==="danger"?"fa-triangle-exclamation":"fa-circle-info"}"></i>
        <div>
          <div class="t-title">${escapeHtml(title)}</div>
          <div class="t-desc">${escapeHtml(desc)}</div>
        </div>
      `;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(-6px)"; }, 2600);
      setTimeout(()=>{ el.remove(); }, 3200);
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function nowISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function nowISODate(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function isoDateOnly(isoDateTime){ return (isoDateTime || "").slice(0,10); }

    function toMoney(v){
      const n = Number(v);
      if (!Number.isFinite(n) || n <= 0) return "—";
      return n.toLocaleString("vi-VN") + " đ";
    }

    function timeToMinutes(t){
      if(!t) return null;
      const [hh,mm] = t.split(":").map(Number);
      if(!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
      return hh*60 + mm;
    }

    function routeLabel(r){ return `${r.from} - ${r.to}`; }

    function linesToArray(text){
      return (text||"").split("\n").map(s=>s.trim()).filter(Boolean);
    }
    function arrayToLines(arr){
      return (arr||[]).join("\n");
    }

    function defaultStopsForBus(from,to){
      return { pickup:[`Bến xe (${from})`], dropoff:[`Bến xe (${to})`] };
    }
    function defaultStopsForLimo(){
      return {
        pickup:["Đón tận nơi (theo địa chỉ khách cung cấp)"],
        dropoff:["Trả tận nơi (theo địa chỉ khách cung cấp)"]
      };
    }

    /* =========================
       2) LOAD/SAVE (đồng bộ list)
       ========================= */
    function loadRoutesFromList(){
      const raw = localStorage.getItem(LS_ROUTES_KEY);
      if(!raw){
        routes = [];
        return;
      }
      try{
        const data = JSON.parse(raw);
        routes = Array.isArray(data) ? data : [];
      }catch{
        routes = [];
      }
    }
    function saveRoutesToList(){
      localStorage.setItem(LS_ROUTES_KEY, JSON.stringify(routes));
    }

    function loadDetailMap(){
      const raw = localStorage.getItem(LS_DETAIL_KEY);
      if(!raw){ detailMap = {}; return; }
      try{
        const data = JSON.parse(raw);
        detailMap = (data && typeof data === "object") ? data : {};
      }catch{
        detailMap = {};
      }
    }
    function saveDetailMap(){
      localStorage.setItem(LS_DETAIL_KEY, JSON.stringify(detailMap));
    }

    function ensureRouteDetail(routeId, routeObj){
      const key = String(routeId);
      if(detailMap[key]) return;

      // tạo mặc định từ dữ liệu giá ở list
      const fares = [];
      const bus = Number(routeObj.priceBus);
      const limo = Number(routeObj.priceLimo);
      if(Number.isFinite(bus) && bus > 0){
        fares.push({ id: Date.now()+1, vehicleType:"Xe khách", price: bus, note:"", validFrom: "2025-09-01" });
      }
      if(Number.isFinite(limo) && limo > 0){
        fares.push({ id: Date.now()+2, vehicleType:"Limousine", price: limo, note:"", validFrom: "2025-10-15" });
      }

      const schedules = [
        { id: Date.now()+101, depart:"06:00", arrive:"08:30", vehicleType:"Xe khách", status:"Đang mở bán", note:"—" },
        { id: Date.now()+102, depart:"09:00", arrive:"11:30", vehicleType:"Limousine", status:"Đang mở bán", note:"Ưu tiên khách đặt trước" },
        { id: Date.now()+103, depart:"14:00", arrive:"16:30", vehicleType:"Xe khách", status:"Đang mở bán", note:"—" },
        { id: Date.now()+104, depart:"18:30", arrive:"21:00", vehicleType:"Limousine", status:"Đang mở bán", note:"Giờ cao điểm" },
      ];

      const stops = {
        bus: defaultStopsForBus(routeObj.from, routeObj.to),
        limo: defaultStopsForLimo()
      };

      detailMap[key] = { fares, schedules, stops };
      saveDetailMap();
    }

    function getRouteById(id){
      return routes.find(r => r.id === id);
    }

    /* =========================
       3) RENDER
       ========================= */
    function statusBadge(status){
      const s = (status||"").toLowerCase();
      if(s.includes("khai thác") || s === "active") return { bg:"#dcfce7", fg:"#166534", icon:"fa-circle-check", label:"Đang khai thác" };
      if(s.includes("tạm") || s === "paused") return { bg:"#fef3c7", fg:"#92400e", icon:"fa-circle-pause", label:"Tạm ngưng" };
      if(s.includes("bảo")) return { bg:"#dbeafe", fg:"#1e40af", icon:"fa-screwdriver-wrench", label:"Bảo trì tuyến" };
      if(s.includes("ngừng") || s === "stopped") return { bg:"#fee2e2", fg:"#991b1b", icon:"fa-circle-xmark", label:"Ngừng khai thác" };
      return { bg:"#e2e8f0", fg:"#334155", icon:"fa-circle-info", label: status || "—" };
    }

    function humanStatus(s){
      if(s === "active") return "Đang khai thác";
      if(s === "paused") return "Tạm ngưng";
      if(s === "stopped") return "Ngừng khai thác";
      return s || "—";
    }

    function renderRelated(){
      const wrap = document.getElementById("relatedRoutes");
      wrap.innerHTML = "";

      const curChip = document.createElement("div");
      curChip.className = "chip active";
      curChip.innerHTML = `<i class="fas fa-location-arrow"></i> ${escapeHtml(routeLabel(currentRoute))} <span style="opacity:.9;">(đang xem)</span>`;
      wrap.appendChild(curChip);

      const related = routes
        .filter(r=>r.id !== currentRoute.id)
        .filter(r=>r.from===currentRoute.from || r.to===currentRoute.to)
        .slice(0, 10);

      const list = related.length ? related : routes.filter(r=>r.id !== currentRoute.id).slice(0, 10);

      list.forEach(r=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `<i class="fas fa-up-right-from-square"></i> ${escapeHtml(routeLabel(r))}`;
        chip.onclick = () => goRoute(r.id);
        wrap.appendChild(chip);
      });
    }

    function renderHeaderAndInfo(){
      const code = currentRoute.code || "—";
      document.getElementById("pageTitle").innerText = `Chi tiết tuyến & giá vé • ${code}`;

      routeCode.innerText = code;
      routeFrom.innerText = currentRoute.from || "—";
      routeTo.innerText = currentRoute.to || "—";
      routeDistance.innerText = currentRoute.distanceKm ? `${currentRoute.distanceKm} km` : "—";
      routeDuration.innerText = currentRoute.duration || "—";

      // loại xe khai thác dựa theo giá ở list
      const hasBus = Number.isFinite(Number(currentRoute.priceBus)) && Number(currentRoute.priceBus) > 0;
      const hasLimo = Number.isFinite(Number(currentRoute.priceLimo)) && Number(currentRoute.priceLimo) > 0;
      routeVehicleMix.innerText = hasBus && hasLimo ? "Xe khách • Limousine" : (hasBus ? "Xe khách" : (hasLimo ? "Limousine" : "—"));

      routePolicy.innerText = currentRoute.policy || "—";
      routeUpdatedAt.innerText = currentRoute.updatedAt || "—";

      const sb = statusBadge(currentRoute.status);
      routeStatusBadge.style.background = sb.bg;
      routeStatusBadge.style.color = sb.fg;
      routeStatusBadge.innerHTML = `<i class="fas ${sb.icon}"></i> ${escapeHtml(humanStatus(currentRoute.status))}`;

      // fill delete modal name
      deleteRouteName.innerText = `${escapeHtml(code)} (${escapeHtml(routeLabel(currentRoute))})`;
    }

    function renderStats(){
      const detail = detailMap[String(currentRoute.id)];
      const schedules = detail?.schedules || [];
      const fares = detail?.fares || [];

      stTripsMonth.innerText = String((schedules.length || 0) * 30);

      const prices = fares.map(f=>Number(f.price)).filter(n=>Number.isFinite(n) && n>0);
      stMinPrice.innerText = prices.length ? toMoney(Math.min(...prices)) : "—";
      stMaxPrice.innerText = prices.length ? toMoney(Math.max(...prices)) : "—";
      stDuration.innerText = currentRoute.duration || "—";
    }

    function fareVisibleByDate(f, dateISO){
      if(!dateISO) return true;
      return (f.validFrom || "0000-00-00") <= dateISO;
    }

    function renderFares(){
      const tbody = document.getElementById("fareTbody");
      tbody.innerHTML = "";

      const vehicle = fareFilterVehicle.value;
      const dateISO = fareFilterDate.value;
      const q = (fareFilterQ.value || "").toLowerCase().trim();

      const detail = detailMap[String(currentRoute.id)];
      let list = (detail?.fares || []).slice();

      if(vehicle !== "all") list = list.filter(f=>f.vehicleType === vehicle);
      list = list.filter(f=>fareVisibleByDate(f, dateISO));
      if(q) list = list.filter(f => (f.note||"").toLowerCase().includes(q));

      list.sort((a,b)=> (b.validFrom||"").localeCompare(a.validFrom||""));

      if(list.length===0){
        tbody.innerHTML = `<tr><td colspan="5" style="color:#64748b;">Không có mức giá phù hợp bộ lọc.</td></tr>`;
        return;
      }

      list.forEach(f=>{
        const badgeStyle = f.vehicleType==="Limousine"
          ? `background:#e0e7ff;color:var(--primary);`
          : `background:#dcfce7;color:#166534;`;

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td><span class="status-badge" style="${badgeStyle}">${escapeHtml(f.vehicleType)}</span></td>
            <td><strong>${toMoney(f.price)}</strong></td>
            <td>${f.note && f.note.trim() ? escapeHtml(f.note) : "—"}</td>
            <td>${escapeHtml(f.validFrom || "—")}</td>
            <td>
              <button class="btn-small" style="background:#e0e7ff;color:var(--primary);" onclick="openEditFareModal(${f.id})">Sửa</button>
              <button class="btn-small" style="background:#fee2e2;color:#dc2626;margin-left:6px;" onclick="deleteFare(${f.id})">Xóa</button>
            </td>
          </tr>
        `);
      });
    }

    function renderTrips(){
      const tbody = document.getElementById("tripTbody");
      tbody.innerHTML = "";

      const vehicle = tripFilterVehicle.value;
      const fromT = tripFilterFromTime.value;
      const toT = tripFilterToTime.value;
      const q = (tripFilterQ.value || "").toLowerCase().trim();

      const detail = detailMap[String(currentRoute.id)];
      let list = (detail?.schedules || []).slice();

      if(vehicle !== "all") list = list.filter(t=>t.vehicleType===vehicle);

      const fromM = timeToMinutes(fromT);
      const toM = timeToMinutes(toT);
      if(fromM !== null) list = list.filter(t => timeToMinutes(t.depart) >= fromM);
      if(toM !== null) list = list.filter(t => timeToMinutes(t.depart) <= toM);

      if(q) list = list.filter(t => (t.note||"").toLowerCase().includes(q));
      list.sort((a,b)=> (a.depart||"").localeCompare(b.depart||""));

      if(list.length===0){
        tbody.innerHTML = `<tr><td colspan="7" style="color:#64748b;">Chưa có chuyến phù hợp bộ lọc.</td></tr>`;
        return;
      }

      list.forEach(t=>{
        const st = (t.status || "").toLowerCase();
        let stColor = "#166534";
        if(st.includes("tạm")) stColor = "#92400e";
        if(st.includes("hết")) stColor = "#991b1b";

        const vehicleBadge = t.vehicleType==="Limousine"
          ? `<span class="status-badge" style="background:#e0e7ff;color:var(--primary);"><i class="fas fa-van-shuttle"></i> Limousine</span>`
          : `<span class="status-badge" style="background:#dcfce7;color:#166534;"><i class="fas fa-bus"></i> Xe khách</span>`;

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td><a class="link-a" href="chi-tiet-tuyen.html?id=${encodeURIComponent(currentRoute.id)}">${escapeHtml(routeLabel(currentRoute))}</a></td>
            <td><strong>${escapeHtml(t.depart || "—")}</strong></td>
            <td>${escapeHtml(t.arrive || "—")}</td>
            <td>${vehicleBadge}</td>
            <td style="color:${stColor};font-weight:900;">${escapeHtml(t.status || "—")}</td>
            <td>${t.note && t.note.trim() ? escapeHtml(t.note) : "—"}</td>
            <td>
              <button class="btn-small" style="background:#e0e7ff;color:var(--primary);" onclick="openEditTripModal(${t.id})">Sửa</button>
              <button class="btn-small" style="background:#fee2e2;color:#dc2626;margin-left:6px;" onclick="deleteTrip(${t.id})">Xóa</button>
            </td>
          </tr>
        `);
      });
    }

    function setList(elId, items){
      const ul = document.getElementById(elId);
      ul.innerHTML = "";
      const arr = (items||[]).filter(Boolean);
      if(arr.length===0){
        const li = document.createElement("li");
        li.style.color = "#64748b";
        li.textContent = "Chưa có dữ liệu";
        ul.appendChild(li);
        return;
      }
      arr.forEach(x=>{
        const li = document.createElement("li");
        li.textContent = x;
        ul.appendChild(li);
      });
    }

    function renderStops(){
      const detail = detailMap[String(currentRoute.id)];
      const s = detail?.stops || {};
      setList("busPickupList", s.bus?.pickup || []);
      setList("busDropoffList", s.bus?.dropoff || []);
      setList("limoPickupList", s.limo?.pickup || []);
      setList("limoDropoffList", s.limo?.dropoff || []);
    }

    function renderAll(){
      renderRelated();
      renderHeaderAndInfo();
      renderStats();
      renderFares();
      renderTrips();
      renderStops();
    }

    /* =========================
       4) CRUD: ROUTE STATUS/INFO
       ========================= */
    function openEditRouteModal(){
      m_routeCode.value = currentRoute.code || "—";
      m_routeFrom.value = currentRoute.from || "";
      m_routeTo.value = currentRoute.to || "";
      m_routeDistance.value = currentRoute.distanceKm || "";
      m_routeDuration.value = currentRoute.duration || "";
      m_routePolicy.value = currentRoute.policy || "";
      m_routeAlert.value = currentRoute.note || "";
      m_routeStatus.value = humanStatus(currentRoute.status);

      openModal("routeEditModal");
    }

    function saveRouteInfo(){
      const from = m_routeFrom.value.trim();
      const to = m_routeTo.value.trim();
      const duration = m_routeDuration.value.trim();

      if(!from || !to || !duration){
        toast("Thiếu thông tin", "Vui lòng nhập đủ: Điểm đi, Điểm đến, Thời gian dự kiến.", "danger");
        return;
      }

      currentRoute.from = from;
      currentRoute.to = to;
      currentRoute.distanceKm = m_routeDistance.value ? Number(m_routeDistance.value) : null;
      currentRoute.duration = duration;
      currentRoute.policy = m_routePolicy.value.trim();
      currentRoute.note = m_routeAlert.value.trim();
      currentRoute.updatedAt = new Date().toLocaleDateString("vi-VN");

      const stText = m_routeStatus.value;
      // map về các status dùng ở list
      if(stText.includes("Đang")) currentRoute.status = "active";
      else if(stText.includes("Tạm")) currentRoute.status = "paused";
      else if(stText.includes("Ngừng")) currentRoute.status = "stopped";
      else currentRoute.status = stText;

      // cập nhật stops mặc định bus theo from/to nếu đang trống
      const detail = detailMap[String(currentRoute.id)];
      if(detail && detail.stops && detail.stops.bus){
        if(!Array.isArray(detail.stops.bus.pickup) || detail.stops.bus.pickup.length===0){
          detail.stops.bus.pickup = defaultStopsForBus(from,to).pickup;
        }
        if(!Array.isArray(detail.stops.bus.dropoff) || detail.stops.bus.dropoff.length===0){
          detail.stops.bus.dropoff = defaultStopsForBus(from,to).dropoff;
        }
        detailMap[String(currentRoute.id)] = detail;
        saveDetailMap();
      }

      routes = routes.map(r => r.id===currentRoute.id ? currentRoute : r);
      saveRoutesToList();
      closeModal("routeEditModal");
      renderAll();
      toast("Cập nhật thành công", "Đã cập nhật thông tin tuyến.", "success");
    }

    function saveRouteStatus(){
      const newStatusText = routeStatusSelect.value;
      const note = (routeStatusNote.value||"").trim();

      if(newStatusText.includes("Đang")) currentRoute.status = "active";
      else if(newStatusText.includes("Tạm")) currentRoute.status = "paused";
      else if(newStatusText.includes("Ngừng")) currentRoute.status = "stopped";
      else currentRoute.status = newStatusText;

      if(note) currentRoute.note = note;
      currentRoute.updatedAt = new Date().toLocaleDateString("vi-VN");

      routes = routes.map(r => r.id===currentRoute.id ? currentRoute : r);
      saveRoutesToList();

      closeModal("routeStatusModal");
      renderAll();
      toast("Cập nhật thành công", "Đã cập nhật trạng thái tuyến.", "success");
    }

    /* =========================
       5) CRUD: FARES
       ========================= */
    function openAddFareModal(){
      editingFareId = null;
      fareModalTitle.innerText = "Thêm mức giá";
      m_fareVehicle.value = "Limousine";
      m_farePrice.value = "";
      m_fareFrom.value = nowISODate();
      m_fareNote.value = "";
      openModal("fareModal");
    }

    function openEditFareModal(id){
      const detail = detailMap[String(currentRoute.id)];
      const f = (detail?.fares || []).find(x=>x.id===id);
      if(!f) return;

      editingFareId = id;
      fareModalTitle.innerText = "Sửa mức giá";
      m_fareVehicle.value = f.vehicleType;
      m_farePrice.value = f.price;
      m_fareFrom.value = f.validFrom || nowISODate();
      m_fareNote.value = f.note || "";
      openModal("fareModal");
    }

    function submitFare(){
      const vehicleType = m_fareVehicle.value;
      const price = Number(m_farePrice.value);
      const validFrom = m_fareFrom.value;
      const note = m_fareNote.value.trim();

      if(!Number.isFinite(price) || price<=0 || !validFrom){
        toast("Thiếu thông tin", "Vui lòng nhập đủ: Giá (>0) và Ngày áp dụng.", "danger");
        return;
      }

      const key = String(currentRoute.id);
      const detail = detailMap[key];

      if(editingFareId){
        detail.fares = detail.fares.map(f =>
          f.id===editingFareId ? ({...f, vehicleType, price, validFrom, note}) : f
        );
      }else{
        const newId = Date.now();
        detail.fares.push({ id:newId, vehicleType, price, validFrom, note });
      }

      detailMap[key] = detail;
      saveDetailMap();

      currentRoute.updatedAt = new Date().toLocaleDateString("vi-VN");
      routes = routes.map(r=>r.id===currentRoute.id?currentRoute:r);
      saveRoutesToList();

      closeModal("fareModal");
      editingFareId = null;
      renderStats();
      renderFares();
      toast("Lưu thành công", "Đã lưu mức giá.", "success");
    }

    function deleteFare(id){
      if(!confirm("Bạn chắc chắn muốn xóa mức giá này?")) return;

      const key = String(currentRoute.id);
      const detail = detailMap[key];
      detail.fares = (detail.fares || []).filter(f=>f.id!==id);
      detailMap[key] = detail;
      saveDetailMap();

      renderStats();
      renderFares();
      toast("Xóa thành công", "Đã xóa mức giá.", "success");
    }

    /* =========================
       6) CRUD: TRIPS
       ========================= */
    function openAddTripModal(){
      editingTripId = null;
      tripModalTitle.innerText = "Thêm chuyến";
      m_tripDepart.value = "";
      m_tripArrive.value = "";
      m_tripVehicle.value = "Xe khách";
      m_tripStatus.value = "Đang mở bán";
      m_tripNote.value = "";
      openModal("tripModal");
    }

    function openEditTripModal(id){
      const key = String(currentRoute.id);
      const detail = detailMap[key];
      const t = (detail?.schedules || []).find(x=>x.id===id);
      if(!t) return;

      editingTripId = id;
      tripModalTitle.innerText = "Sửa chuyến";
      m_tripDepart.value = t.depart || "";
      m_tripArrive.value = t.arrive || "";
      m_tripVehicle.value = t.vehicleType || "Xe khách";
      m_tripStatus.value = t.status || "Đang mở bán";
      m_tripNote.value = t.note || "";
      openModal("tripModal");
    }

    function submitTrip(){
      const depart = m_tripDepart.value;
      const arrive = m_tripArrive.value;
      const vehicleType = m_tripVehicle.value;
      const status = m_tripStatus.value;
      const note = m_tripNote.value.trim();

      if(!depart || !arrive){
        toast("Thiếu thông tin", "Vui lòng nhập đủ: Giờ xuất bến và Giờ đến dự kiến.", "danger");
        return;
      }

      const key = String(currentRoute.id);
      const detail = detailMap[key];

      if(editingTripId){
        detail.schedules = detail.schedules.map(t =>
          t.id===editingTripId ? ({...t, depart, arrive, vehicleType, status, note}) : t
        );
      }else{
        const newId = Date.now();
        detail.schedules.push({ id:newId, depart, arrive, vehicleType, status, note });
      }

      detailMap[key] = detail;
      saveDetailMap();

      currentRoute.updatedAt = new Date().toLocaleDateString("vi-VN");
      routes = routes.map(r=>r.id===currentRoute.id?currentRoute:r);
      saveRoutesToList();

      closeModal("tripModal");
      editingTripId = null;
      renderStats();
      renderTrips();
      toast("Lưu thành công", "Đã lưu chuyến.", "success");
    }

    function deleteTrip(id){
      if(!confirm("Bạn chắc chắn muốn xóa chuyến này?")) return;

      const key = String(currentRoute.id);
      const detail = detailMap[key];
      detail.schedules = (detail.schedules || []).filter(t=>t.id!==id);
      detailMap[key] = detail;
      saveDetailMap();

      renderStats();
      renderTrips();
      toast("Xóa thành công", "Đã xóa chuyến.", "success");
    }

    /* =========================
       7) CRUD: STOPS
       ========================= */
    function openEditStopsModal(){
      const key = String(currentRoute.id);
      const detail = detailMap[key];
      const bus = detail?.stops?.bus || defaultStopsForBus(currentRoute.from, currentRoute.to);
      const limo = detail?.stops?.limo || defaultStopsForLimo();

      m_busPickup.value = arrayToLines(bus.pickup || []);
      m_busDropoff.value = arrayToLines(bus.dropoff || []);
      m_limoPickup.value = arrayToLines(limo.pickup || []);
      m_limoDropoff.value = arrayToLines(limo.dropoff || []);
      openModal("stopsModal");
    }

    function saveStops(){
      const busPickup = linesToArray(m_busPickup.value);
      const busDropoff = linesToArray(m_busDropoff.value);
      const limoPickup = linesToArray(m_limoPickup.value);
      const limoDropoff = linesToArray(m_limoDropoff.value);

      const defBus = defaultStopsForBus(currentRoute.from, currentRoute.to);
      const defLimo = defaultStopsForLimo();

      const key = String(currentRoute.id);
      const detail = detailMap[key];

      detail.stops = {
        bus: {
          pickup: busPickup.length ? busPickup : defBus.pickup,
          dropoff: busDropoff.length ? busDropoff : defBus.dropoff,
        },
        limo: {
          pickup: limoPickup.length ? limoPickup : defLimo.pickup,
          dropoff: limoDropoff.length ? limoDropoff : defLimo.dropoff,
        }
      };

      detailMap[key] = detail;
      saveDetailMap();

      currentRoute.updatedAt = new Date().toLocaleDateString("vi-VN");
      routes = routes.map(r=>r.id===currentRoute.id?currentRoute:r);
      saveRoutesToList();

      closeModal("stopsModal");
      renderStops();
      toast("Cập nhật thành công", "Đã cập nhật điểm đón/trả.", "success");
    }

    /* =========================
       8) DELETE ROUTE + LOG (giống màn list)
       ========================= */
    function loadDeleteLogs(){
      const raw = localStorage.getItem(LS_DELETE_LOG_KEY);
      if(!raw) return [];
      try{
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      }catch{
        return [];
      }
    }
    function saveDeleteLogs(logs){
      localStorage.setItem(LS_DELETE_LOG_KEY, JSON.stringify(logs));
    }

    function deleteRoute(){
      const reason = deleteReason.value.trim();
      if(!reason){
        toast("Thiếu lý do", "Vui lòng nhập lý do xóa tuyến.", "danger");
        return;
      }
      if(!confirm("Xác nhận xóa tuyến này?")) return;

      // 1) log
      const logs = loadDeleteLogs();
      logs.unshift({
        deletedAt: nowISO(),
        routeId: currentRoute.id,
        routeCode: currentRoute.code,
        from: currentRoute.from,
        to: currentRoute.to,
        priceBus: currentRoute.priceBus ?? null,
        priceLimo: currentRoute.priceLimo ?? null,
        status: currentRoute.status,
        note: currentRoute.note || "",
        reason,
        deletedBy: CURRENT_USER.name,
        role: CURRENT_USER.role
      });
      saveDeleteLogs(logs);

      // 2) delete in list
      routes = routes.filter(r=>r.id !== currentRoute.id);
      saveRoutesToList();

      // 3) delete detail map
      const key = String(currentRoute.id);
      delete detailMap[key];
      saveDetailMap();

      closeModal("routeDeleteModal");
      toast("Xóa thành công", `Đã xóa tuyến ${currentRoute.from} - ${currentRoute.to}.`, "success");

      // 4) navigate
      if(routes.length){
        goRoute(routes[0].id);
      }else{
        goBackToList();
      }
    }

    /* =========================
       9) DELETE LOG VIEW
       ========================= */
    function openDeleteLogModal(){
      document.getElementById("logQ").value = "";
      document.getElementById("logFrom").value = "";
      document.getElementById("logTo").value = "";
      renderDeleteLogs();
      openModal("deleteLogModal");
    }
    function clearDeleteLogs(){
      localStorage.removeItem(LS_DELETE_LOG_KEY);
      renderDeleteLogs();
      toast("Đã xóa log", "Toàn bộ log xóa tuyến đã được xóa (demo).", "info");
    }
    function renderDeleteLogs(){
      const tbody = document.getElementById("logTbody");
      tbody.innerHTML = "";

      const q = (document.getElementById("logQ").value || "").trim().toLowerCase();
      const fromD = document.getElementById("logFrom").value || "";
      const toD = document.getElementById("logTo").value || "";

      const logs = loadDeleteLogs();
      const filtered = logs.filter(item => {
        const hay = `${item.routeCode} ${item.from} ${item.to} ${item.reason} ${item.deletedBy}`.toLowerCase();
        if(q && !hay.includes(q)) return false;
        const dOnly = isoDateOnly(item.deletedAt);
        if(fromD && dOnly < fromD) return false;
        if(toD && dOnly > toD) return false;
        return true;
      });

      document.getElementById("logCountChip").innerHTML = `<i class="fas fa-database"></i> ${filtered.length} bản ghi`;

      if(!filtered.length){
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding:16px;">
              <div class="empty">Chưa có log xóa tuyến (hoặc không khớp bộ lọc).</div>
            </td>
          </tr>
        `;
        return;
      }

      filtered.forEach(item=>{
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td style="white-space:nowrap;"><strong>${escapeHtml(item.deletedAt)}</strong></td>
            <td>${escapeHtml(item.from)} - ${escapeHtml(item.to)}</td>
            <td><strong>${escapeHtml(item.routeCode)}</strong></td>
            <td>${escapeHtml(item.reason)}</td>
            <td>${escapeHtml(item.deletedBy)} <span style="color:#94a3b8;font-weight:800;">(${escapeHtml(item.role || "—")})</span></td>
          </tr>
        `);
      });
    }

    /* =========================
       10) FILTER EVENTS
       ========================= */
    function bindFilters(){
      // fares
      fareFilterDate.value = nowISODate();
      ["fareFilterVehicle","fareFilterDate","fareFilterQ"].forEach(id=>{
        document.getElementById(id).addEventListener("input", renderFares);
        document.getElementById(id).addEventListener("change", renderFares);
      });

      // trips
      ["tripFilterVehicle","tripFilterFromTime","tripFilterToTime","tripFilterQ"].forEach(id=>{
        document.getElementById(id).addEventListener("input", renderTrips);
        document.getElementById(id).addEventListener("change", renderTrips);
      });
    }

    /* =========================
       11) NAV
       ========================= */
    function goRoute(id){
      window.location.href = `chi-tiet-tuyen.html?id=${encodeURIComponent(id)}`;
    }
    function goBackToList(){
      // nếu bạn đặt file list tên khác, đổi URL ở đây
      window.location.href = `quan-ly-tuyen.html`;
    }

    /* =========================
       INIT
       ========================= */
    window.addEventListener("DOMContentLoaded", ()=>{
      loadRoutesFromList();
      loadDetailMap();

      if(!routes.length){
        document.getElementById("pageTitle").innerText = "Chưa có dữ liệu tuyến (hãy mở màn danh sách để tạo tuyến)";
        toast("Chưa có dữ liệu", "Bạn hãy mở màn “Quản lý tuyến & giá vé” để tạo dữ liệu trước.", "info");
        return;
      }

      const routeId = getParam("id");
      // id trong list là string (uid), nên giữ nguyên
      const id = routeId ? String(routeId) : String(routes[0].id);

      currentRoute = getRouteById(id) || routes[0];
      if(!currentRoute){
        document.getElementById("pageTitle").innerText = "Không tìm thấy tuyến";
        toast("Không tìm thấy", "Tuyến bạn cần xem không tồn tại.", "danger");
        return;
      }

      ensureRouteDetail(currentRoute.id, currentRoute);

      // set delete name
      document.getElementById("deleteRouteName").innerText = `${currentRoute.code || "—"} (${routeLabel(currentRoute)})`;

      bindFilters();
      renderAll();
    });
  </script>
</body>
</html>
