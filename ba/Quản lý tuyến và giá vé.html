<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý Tuyến & Giá vé - Nhà Xe Thăng Long</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#4361ee;
      --sidebar-bg:#0f0f1a;
      --sidebar-hover:#1e1e2e;
      --border-radius:20px;
      --green:#10b981;
      --blue:#3b82f6;
      --yellow:#f59e0b;
      --red:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
    body{background:#f8fafc;color:#333;display:flex;min-height:100vh;}

    /* Sidebar */
    .sidebar{
      width:280px;background:var(--sidebar-bg);color:white;padding:30px 20px;
      position:fixed;height:100vh;overflow-y:auto;
      border-radius:0 var(--border-radius) var(--border-radius) 0;
      box-shadow:8px 0 30px rgba(0,0,0,.4);z-index:1000;
    }
    .user-info{display:flex;align-items:center;gap:14px;padding-bottom:24px;border-bottom:1px solid #2d2d44;margin-bottom:30px;}
    .user-info img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:3px solid #374151;}
    .user-info .info h3{font-size:17px;font-weight:600;margin-bottom:4px;}
    .user-info .info p{font-size:13px;color:#94a3b8;}
    .menu-title{text-transform:uppercase;font-size:11px;color:#64748b;letter-spacing:1.5px;margin:20px 0 12px;font-weight:600;}
    .menu{list-style:none;}
    .menu a{display:flex;align-items:center;gap:14px;padding:14px 18px;color:#94a3b8;text-decoration:none;border-radius:14px;transition:all .3s;font-size:15px;font-weight:500;}
    .menu a i{font-size:18px;width:24px;text-align:center;}
    .menu a:hover{background:var(--sidebar-hover);color:white;}
    .menu a.active{background:white!important;color:var(--primary)!important;font-weight:600;box-shadow:0 6px 20px rgba(67,97,238,.25);}
    .menu a.active i{color:var(--primary)!important;}

    /* Main */
    .main-content{flex:1;margin-left:280px;padding:30px;background:#f1f5f9;min-height:100vh;}
    .top-bar{
      background:white;padding:20px 30px;border-radius:var(--border-radius);
      box-shadow:0 4px 20px rgba(0,0,0,.06);display:flex;justify-content:space-between;
      align-items:center;margin-bottom:22px;
    }
    .greeting{font-size:18px;font-weight:500;color:#1e293b;}
    .greeting span{color:#94a3b8;font-size:16px;}
    .notification{position:relative;width:40px;height:40px;background:#f1f5f9;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .notification .badge{position:absolute;top:-4px;right:-4px;background:#ef4444;color:white;font-size:10px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;}

    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;}
    .page-header h1{font-size:26px;font-weight:700;color:#1e293b;}
    .actions-right{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{
      border:none;border-radius:12px;padding:12px 16px;font-size:14px;font-weight:600;cursor:pointer;
      display:flex;align-items:center;gap:8px;transition:.2s;
    }
    .btn:hover{opacity:.92;}
    .btn-primary{background:var(--primary);color:white;}
    .btn-secondary{background:#e2e8f0;color:#475569;}
    .btn-danger{background:#fee2e2;color:#991b1b;}
    .btn-outline{background:white;color:#334155;border:1px solid #e2e8f0;}

    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:14px 0 22px;}
    .stat-card{
      background:white;padding:18px;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.05);
    }
    .stat-card .label{color:#64748b;font-size:13px;margin-bottom:8px;font-weight:600;}
    .stat-card .value{font-size:24px;font-weight:800;color:#0f172a;}
    .stat-card .sub{margin-top:6px;color:#94a3b8;font-size:13px;}

    /* Filters */
    .filter-wrap{
      background:white;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.05);
      padding:16px;margin-bottom:16px;
    }
    .filter-title{display:flex;align-items:center;gap:10px;color:#334155;font-weight:800;margin-bottom:12px;}
    .filters{
      display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:end;
    }
    .field label{display:block;font-size:12px;color:#64748b;font-weight:700;margin-bottom:6px;}
    .field input,.field select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;font-size:14px;
    }
    .field .hint{font-size:12px;color:#94a3b8;margin-top:6px;}
    .btn-sm{padding:10px 12px;border-radius:12px;font-size:13px;font-weight:800;}
    .btn-icon{width:44px;justify-content:center;}

    /* Table */
    table{width:100%;border-collapse:collapse;background:white;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.05);}
    thead{background:#f8fafc;}
    th,td{padding:14px 16px;text-align:left;font-size:14px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
    th{color:#475569;font-weight:800;}
    tbody tr:hover{background:#f8fafc;}
    .route-link{
      color:#0f172a;font-weight:800;text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;
    }
    .route-link:hover{color:var(--primary);}
    .pill{padding:6px 12px;border-radius:999px;font-size:12px;font-weight:800;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;}
    .pill-bus{background:#dcfce7;color:#166534;}
    .pill-limo{background:#e0e7ff;color:#3730a3;}
    .muted{color:#94a3b8;font-weight:700;}
    .price{font-weight:900;color:#0f172a;}
    .actions a{margin-right:10px;color:#64748b;font-size:18px;cursor:pointer;transition:.2s;}
    .actions a:hover{color:var(--primary);}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:9999;}
    .modal.active{display:flex;}
    .modal-content{background:white;width:92%;max-width:760px;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.3);animation:zoom .2s;}
    @keyframes zoom{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
    .modal-header{padding:18px 20px;background:var(--primary);color:white;font-size:16px;font-weight:900;display:flex;justify-content:space-between;align-items:center;}
    .modal-header.danger{background:var(--red);}
    .modal-body{padding:20px;max-height:70vh;overflow:auto;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .form-group{margin-bottom:12px;}
    .form-group label{display:block;margin-bottom:6px;font-weight:800;color:#334155;font-size:13px;}
    .form-group label .required{color:var(--red);}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:12px;font-size:14px;
    }
    .modal-note{font-size:13px;color:#64748b;margin-top:8px;}
    .modal-footer{display:none !important;} /* giữ yêu cầu: không có thanh lưu/hủy */

    /* Log table */
    .log-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;
    }
    .log-head h3{font-size:16px;color:#0f172a;}
    .mini-actions{display:flex;gap:10px;flex-wrap:wrap;}
    .badge-chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;background:#f1f5f9;border:1px solid #e2e8f0;
      font-weight:800;color:#334155;font-size:12px;
    }
    .empty{
      padding:14px;border:1px dashed #cbd5e1;border-radius:14px;color:#64748b;background:#fff;
    }

    /* Toast */
    .toast-wrap{position:fixed;top:18px;right:18px;z-index:10000;display:flex;flex-direction:column;gap:10px;}
    .toast{
      background:#0f172a;color:white;border-radius:14px;padding:12px 14px;min-width:280px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;gap:10px;align-items:flex-start;
    }
    .toast i{margin-top:2px;}
    .toast .t-title{font-weight:900;margin-bottom:2px;}
    .toast .t-desc{color:#cbd5e1;font-size:13px;line-height:1.35;}
    .toast.success{background:#052e16;}
    .toast.danger{background:#450a0a;}
    .toast.info{background:#0b1b4b;}

    @media (max-width:992px){
      .sidebar{width:80px;padding:20px 10px;}
      .sidebar .user-info .info,.sidebar .menu-title,.sidebar .menu a span{display:none;}
      .sidebar a{justify-content:center;}
      .main-content{margin-left:80px;}
      .stats-grid{grid-template-columns:repeat(2,1fr);}
      .filters{grid-template-columns:1fr 1fr;}
      .form-row{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="user-info">
      <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User">
      <div class="info">
        <h3>Samantha</h3>
        <p>+098 (99) 439-49-16</p>
      </div>
    </div>
    <p class="menu-title">MAIN MENU</p>
    <ul class="menu">
      <li><a href="#"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fas fa-car"></i> <span>Đặt xe</span></a></li>
      <li><a href="#"><i class="fas fa-car-side"></i> <span>Quản lý thông tin xe</span></a></li>
      <li><a href="#"><i class="fas fa-user-tie"></i> <span>Quản lý tài xế</span></a></li>
      <li><a href="#"><i class="fas fa-users"></i> <span>Quản lý tài khoản</span></a></li>
      <li><a href="#" class="active"><i class="fas fa-map-marked-alt"></i> <span>Quản lý tuyến & giá vé</span></a></li>
      <li><a href="#"><i class="fas fa-clock"></i> <span>Phân xe tự động</span></a></li>
      <li><a href="#"><i class="fas fa-cog"></i> <span>Cài đặt</span></a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="top-bar">
      <div class="greeting">Chào buổi sáng, Samantha <span>bạn có 2 thông báo mới</span></div>
      <div class="notification" title="Thông báo">
        <i class="fas fa-bell" style="font-size:18px;color:#64748b;"></i>
        <div class="badge">2</div>
      </div>
    </div>

    <div class="page-header">
      <h1>Quản lý Tuyến & Giá vé</h1>
      <div class="actions-right">
        <button class="btn btn-secondary" onclick="openLogModal()" title="Xem log tuyến đã xóa">
          <i class="fas fa-file-lines"></i> Log xóa tuyến
        </button>
        <button class="btn btn-primary" onclick="openAddModal()">
          <i class="fas fa-plus"></i> Thêm tuyến
        </button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Tổng tuyến</div>
        <div class="value" id="statTotal">0</div>
        <div class="sub">đang quản lý</div>
      </div>
      <div class="stat-card">
        <div class="label">Có Xe khách</div>
        <div class="value" id="statBus">0</div>
        <div class="sub">tuyến có giá xe khách</div>
      </div>
      <div class="stat-card">
        <div class="label">Có Limousine</div>
        <div class="value" id="statLimo">0</div>
        <div class="sub">tuyến có giá limousine</div>
      </div>
      <div class="stat-card">
        <div class="label">Giá cao nhất</div>
        <div class="value" id="statMax">—</div>
        <div class="sub">tính theo giá lớn nhất</div>
      </div>
    </div>

    <div class="filter-wrap">
      <div class="filter-title"><i class="fas fa-filter"></i> Bộ lọc</div>

      <div class="filters">
        <div class="field">
          <label>Tìm kiếm tuyến</label>
          <input id="q" type="text" placeholder="Ví dụ: Hà Nội - Hải Phòng / TL-HN-HP..." oninput="applyFilters()"/>
          <div class="hint">Tìm theo mã tuyến, điểm đi/đến</div>
        </div>

        <div class="field">
          <label>Loại xe</label>
          <select id="vehicleFilter" onchange="applyFilters()">
            <option value="all">Tất cả</option>
            <option value="bus">Chỉ Xe khách</option>
            <option value="limo">Chỉ Limousine</option>
            <option value="both">Có cả 2 loại</option>
          </select>
        </div>

        <div class="field">
          <label>Giá từ (VNĐ)</label>
          <input id="minPrice" type="number" min="0" placeholder="VD: 130000" oninput="applyFilters()"/>
        </div>

        <div class="field">
          <label>Giá đến (VNĐ)</label>
          <input id="maxPrice" type="number" min="0" placeholder="VD: 300000" oninput="applyFilters()"/>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button class="btn btn-secondary btn-sm btn-icon" title="Xóa lọc" onclick="clearFilters()">
            <i class="fas fa-broom"></i>
          </button>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:34%;">Tuyến</th>
          <th>Mã tuyến</th>
          <th>Giá Xe khách</th>
          <th>Giá Limousine</th>
          <th style="width:160px;">Loại khai thác</th>
          <th style="width:120px;">Thao tác</th>
        </tr>
      </thead>
      <tbody id="routesBody"></tbody>
    </table>
  </main>

  <!-- MODAL: Thêm/Sửa tuyến -->
  <div id="routeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span id="routeModalTitle"><i class="fas fa-route"></i> Thêm tuyến</span>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn btn-outline btn-sm"
                  style="background:rgba(255,255,255,.15);color:white;border-color:rgba(255,255,255,.3);"
                  onclick="saveRoute()">
            <i class="fas fa-save"></i> Lưu
          </button>
          <i class="fas fa-times" onclick="closeModal('routeModal')" style="cursor:pointer;font-size:20px;"></i>
        </div>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editingId" value=""/>

        <div class="form-row">
          <div class="form-group">
            <label>Mã tuyến <span class="required">*</span></label>
            <input id="routeCode" type="text" placeholder="VD: TL-HN-HP-001"/>
            <div class="modal-note">Mã tuyến phải duy nhất (unique).</div>
          </div>
          <div class="form-group">
            <label>Trạng thái</label>
            <select id="routeStatus">
              <option value="active" selected>Đang khai thác</option>
              <option value="paused">Tạm ngưng</option>
              <option value="stopped">Ngừng khai thác</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Điểm đi <span class="required">*</span></label>
            <input id="from" type="text" placeholder="VD: Hà Nội"/>
          </div>
          <div class="form-group">
            <label>Điểm đến <span class="required">*</span></label>
            <input id="to" type="text" placeholder="VD: Hải Phòng"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Giá Xe khách (VNĐ)</label>
            <input id="priceBus" type="number" min="0" placeholder="VD: 130000"/>
            <div class="modal-note">Nếu tuyến không có Xe khách → để trống.</div>
          </div>
          <div class="form-group">
            <label>Giá Limousine (VNĐ)</label>
            <input id="priceLimo" type="number" min="0" placeholder="VD: 250000"/>
            <div class="modal-note">Nếu tuyến không có Limousine → để trống.</div>
          </div>
        </div>

        <div class="form-group">
          <label>Ghi chú</label>
          <textarea id="note" rows="3" placeholder="VD: áp dụng lễ/Tết, chính sách đổi vé..."></textarea>
        </div>

        <div class="modal-note">
          ✅ Tuyến có thể chỉ khai thác 1 loại xe, nhưng phải có ít nhất 1 mức giá.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Xóa tuyến -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header danger">
        <span><i class="fas fa-trash-alt"></i> Xóa tuyến</span>
        <i class="fas fa-times" onclick="closeModal('deleteModal')" style="cursor:pointer;font-size:20px;"></i>
      </div>

      <div class="modal-body">
        <input type="hidden" id="deleteId" />
        <p>Bạn có chắc chắn muốn xóa tuyến: <strong id="deleteName">—</strong>?</p>
        <p style="margin-top:10px;color:#b91c1c;font-weight:800;">Hành động này không thể hoàn tác.</p>

        <div class="form-group" style="margin-top:12px;">
          <label>Lý do xóa <span class="required">*</span></label>
          <textarea id="deleteReason" rows="3" placeholder="Nhập lý do bắt buộc..."></textarea>
        </div>

        <button class="btn btn-danger" onclick="confirmDelete()" style="margin-top:6px;">
          <i class="fas fa-trash"></i> Xóa ngay
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOG XÓA TUYẾN -->
  <div id="deleteLogModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span><i class="fas fa-file-lines"></i> Log xóa tuyến (theo dõi thay đổi)</span>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn btn-outline btn-sm"
                  style="background:rgba(255,255,255,.15);color:white;border-color:rgba(255,255,255,.3);"
                  onclick="clearDeleteLogs()">
            <i class="fas fa-broom"></i> Xóa log
          </button>
          <i class="fas fa-times" onclick="closeModal('deleteLogModal')" style="cursor:pointer;font-size:20px;"></i>
        </div>
      </div>

      <div class="modal-body">
        <div class="log-head">
          <h3>Danh sách tuyến đã bị xóa</h3>
          <div class="mini-actions">
            <span class="badge-chip" id="logCountChip"><i class="fas fa-database"></i> 0 bản ghi</span>
          </div>
        </div>

        <div class="filters" style="grid-template-columns:2fr 1fr 1fr auto;">
          <div class="field">
            <label>Tìm trong log</label>
            <input id="logQ" type="text" placeholder="Tìm theo mã tuyến / điểm đi/đến / người xóa..." oninput="renderDeleteLog()">
            <div class="hint">Dùng để giám sát thay đổi (audit)</div>
          </div>
          <div class="field">
            <label>Từ ngày</label>
            <input id="logFrom" type="date" oninput="renderDeleteLog()">
          </div>
          <div class="field">
            <label>Đến ngày</label>
            <input id="logTo" type="date" oninput="renderDeleteLog()">
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn btn-secondary btn-sm btn-icon" title="Xóa lọc log" onclick="clearLogFilters()">
              <i class="fas fa-broom"></i>
            </button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Thời gian</th>
              <th>Tuyến</th>
              <th>Mã tuyến</th>
              <th>Lý do xóa</th>
              <th>Người thao tác</th>
            </tr>
          </thead>
          <tbody id="logTbody"></tbody>
        </table>

        <div class="modal-note" style="margin-top:10px;">
          Log được lưu localStorage để mô phỏng audit trail. Khi làm backend thật: chuyển sang DB + phân quyền giám đốc.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap"></div>

  <script>
    /* =========================
       0) KEY + DEMO USER
       ========================= */
    const LS_KEY = "thanglong_routes_v2";
    const LS_DELETE_LOG_KEY = "thanglong_routes_delete_log_v1";
    const CURRENT_USER = { name: "Samantha", role: "Dispatcher" }; // demo

    /* =========================
       1) DỮ LIỆU BAN ĐẦU
       ========================= */
    const DEFAULT_ROUTES = [
      { id: "r1", code:"TL-HN-HP-001", from:"Hà Nội", to:"Hải Phòng", priceBus:130000, priceLimo:250000, status:"active", note:"" },
      { id: "r2", code:"TL-HN-TB-001", from:"Hà Nội", to:"Thái Bình", priceBus:130000, priceLimo:250000, status:"active", note:"" },
      { id: "r3", code:"TL-HN-TH-001", from:"Hà Nội", to:"Thanh Hóa", priceBus:200000, priceLimo:280000, status:"active", note:"" },
      { id: "r4", code:"TL-HN-NA-001", from:"Hà Nội", to:"Nghệ An", priceBus:260000, priceLimo:320000, status:"active", note:"" },
      { id: "r5", code:"TL-HN-HT-001", from:"Hà Nội", to:"Hà Tĩnh", priceBus:300000, priceLimo:380000, status:"active", note:"" },
    ];

    function uid() {
      return "r" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
    function nowISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function isoDateOnly(isoDateTime){
      // "YYYY-MM-DD HH:mm:ss" -> "YYYY-MM-DD"
      return (isoDateTime || "").slice(0,10);
    }

    function structuredCloneSafe(x){
      return JSON.parse(JSON.stringify(x));
    }

    function loadRoutes() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return structuredCloneSafe(DEFAULT_ROUTES);
      try {
        const data = JSON.parse(raw);
        if (!Array.isArray(data)) return structuredCloneSafe(DEFAULT_ROUTES);
        return data;
      } catch {
        return structuredCloneSafe(DEFAULT_ROUTES);
      }
    }
    function saveRoutesToLS(data) {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    function loadDeleteLogs(){
      const raw = localStorage.getItem(LS_DELETE_LOG_KEY);
      if(!raw) return [];
      try{
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      }catch{
        return [];
      }
    }
    function saveDeleteLogs(logs){
      localStorage.setItem(LS_DELETE_LOG_KEY, JSON.stringify(logs));
    }

    let routes = loadRoutes();

    /* =========================
       2) RENDER
       ========================= */
    function fmtVND(n){
      if (n === null || n === undefined || n === "") return "—";
      const v = Number(n);
      if (!Number.isFinite(v) || v <= 0) return "—";
      return v.toLocaleString("vi-VN") + " đ";
    }

    function getTypePills(r){
      const bus = Number(r.priceBus);
      const limo = Number(r.priceLimo);
      const hasBus = Number.isFinite(bus) && bus > 0;
      const hasLimo = Number.isFinite(limo) && limo > 0;

      if (hasBus && hasLimo) {
        return `
          <span class="pill pill-bus"><i class="fas fa-bus"></i> Xe khách</span>
          <span class="pill pill-limo"><i class="fas fa-van-shuttle"></i> Limousine</span>
        `;
      }
      if (hasBus) return `<span class="pill pill-bus"><i class="fas fa-bus"></i> Xe khách</span>`;
      if (hasLimo) return `<span class="pill pill-limo"><i class="fas fa-van-shuttle"></i> Limousine</span>`;
      return `<span class="muted">Chưa cấu hình</span>`;
    }

    function renderStats(list){
      document.getElementById("statTotal").textContent = list.length;

      let cBus = 0, cLimo = 0;
      let maxPrice = 0;

      list.forEach(r => {
        const bus = Number(r.priceBus);
        const limo = Number(r.priceLimo);

        if (Number.isFinite(bus) && bus > 0) cBus++;
        if (Number.isFinite(limo) && limo > 0) cLimo++;

        const localMax = Math.max(Number.isFinite(bus)?bus:0, Number.isFinite(limo)?limo:0);
        if (localMax > maxPrice) maxPrice = localMax;
      });

      document.getElementById("statBus").textContent = cBus;
      document.getElementById("statLimo").textContent = cLimo;
      document.getElementById("statMax").textContent = maxPrice ? fmtVND(maxPrice) : "—";
    }

    function renderTable(list){
      const tbody = document.getElementById("routesBody");
      tbody.innerHTML = "";

      if (!list.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="padding:20px;color:#64748b;">
              Không có tuyến phù hợp bộ lọc.
            </td>
          </tr>
        `;
        renderStats(list);
        return;
      }

      list.forEach(r => {
        const routeName = `${r.from} - ${r.to}`;
        const detailHref = `route-detail.html?id=${encodeURIComponent(r.id)}`; // trang chi tiết sẽ làm sau

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>
              <a class="route-link" href="${detailHref}" title="Xem chi tiết tuyến">
                <i class="fas fa-up-right-from-square" style="color:#94a3b8;"></i>
                ${routeName}
              </a>
              <div class="muted" style="margin-top:6px;">
                ${r.status === "active" ? "Đang khai thác" : (r.status === "paused" ? "Tạm ngưng" : "Ngừng khai thác")}
              </div>
            </td>
            <td><strong>${r.code || "—"}</strong></td>
            <td class="price">${fmtVND(r.priceBus)}</td>
            <td class="price">${fmtVND(r.priceLimo)}</td>
            <td>${getTypePills(r)}</td>
            <td class="actions">
              <a href="${detailHref}" title="Xem chi tiết"><i class="fas fa-eye"></i></a>
              <a onclick="editRoute('${r.id}')" title="Sửa"><i class="fas fa-edit"></i></a>
              <a onclick="askDelete('${r.id}')" title="Xóa"><i class="fas fa-trash-alt"></i></a>
            </td>
          </tr>
        `);
      });

      renderStats(list);
    }

    /* =========================
       3) FILTER
       ========================= */
    function applyFilters(){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      const vehicle = document.getElementById("vehicleFilter").value;
      const minP = Number(document.getElementById("minPrice").value || 0);
      const maxP = document.getElementById("maxPrice").value ? Number(document.getElementById("maxPrice").value) : null;

      const filtered = routes.filter(r => {
        const name = `${r.from} - ${r.to}`.toLowerCase();
        const code = (r.code || "").toLowerCase();
        if (q && !name.includes(q) && !code.includes(q)) return false;

        const bus = Number(r.priceBus);
        const limo = Number(r.priceLimo);
        const hasBus = Number.isFinite(bus) && bus > 0;
        const hasLimo = Number.isFinite(limo) && limo > 0;

        if (vehicle === "bus" && !hasBus) return false;
        if (vehicle === "limo" && !hasLimo) return false;
        if (vehicle === "both" && !(hasBus && hasLimo)) return false;

        const prices = [];
        if (hasBus) prices.push(bus);
        if (hasLimo) prices.push(limo);
        if (!prices.length) return false;

        const minRoutePrice = Math.min(...prices);
        if (minRoutePrice < minP) return false;
        if (maxP !== null && Number.isFinite(maxP) && minRoutePrice > maxP) return false;

        return true;
      });

      renderTable(filtered);
    }

    function clearFilters(){
      document.getElementById("q").value = "";
      document.getElementById("vehicleFilter").value = "all";
      document.getElementById("minPrice").value = "";
      document.getElementById("maxPrice").value = "";
      renderTable(routes);
    }

    /* =========================
       4) MODAL + CRUD
       ========================= */
    function openModal(id){ document.getElementById(id).classList.add("active"); }
    function closeModal(id){ document.getElementById(id).classList.remove("active"); }

    function openAddModal(){
      resetForm();
      document.getElementById("routeModalTitle").innerHTML = `<i class="fas fa-route"></i> Thêm tuyến`;
      openModal("routeModal");
    }

    function resetForm(){
      document.getElementById("editingId").value = "";
      document.getElementById("routeCode").value = "";
      document.getElementById("routeStatus").value = "active";
      document.getElementById("from").value = "";
      document.getElementById("to").value = "";
      document.getElementById("priceBus").value = "";
      document.getElementById("priceLimo").value = "";
      document.getElementById("note").value = "";
    }

    function editRoute(id){
      const r = routes.find(x => x.id === id);
      if (!r) return;

      document.getElementById("routeModalTitle").innerHTML = `<i class="fas fa-pen"></i> Chỉnh sửa tuyến`;
      document.getElementById("editingId").value = r.id;

      document.getElementById("routeCode").value = r.code || "";
      document.getElementById("routeStatus").value = r.status || "active";
      document.getElementById("from").value = r.from || "";
      document.getElementById("to").value = r.to || "";
      document.getElementById("priceBus").value = (r.priceBus ?? "");
      document.getElementById("priceLimo").value = (r.priceLimo ?? "");
      document.getElementById("note").value = r.note || "";

      openModal("routeModal");
    }

    function normalizeCode(code){
      return (code || "").trim().toUpperCase();
    }

    function saveRoute(){
      const editingId = document.getElementById("editingId").value || "";
      const code = normalizeCode(document.getElementById("routeCode").value);
      const status = document.getElementById("routeStatus").value;
      const from = document.getElementById("from").value.trim();
      const to = document.getElementById("to").value.trim();

      const priceBusRaw = document.getElementById("priceBus").value.trim();
      const priceLimoRaw = document.getElementById("priceLimo").value.trim();

      const priceBus = priceBusRaw === "" ? null : Number(priceBusRaw);
      const priceLimo = priceLimoRaw === "" ? null : Number(priceLimoRaw);

      const note = document.getElementById("note").value.trim();

      // validate required
      if (!code || !from || !to){
        toast("Thiếu thông tin", "Vui lòng nhập Mã tuyến, Điểm đi, Điểm đến.", "danger");
        return;
      }

      // validate price: at least one
      const hasBus = Number.isFinite(priceBus) && priceBus > 0;
      const hasLimo = Number.isFinite(priceLimo) && priceLimo > 0;
      if (!hasBus && !hasLimo){
        toast("Chưa có giá", "Bạn cần nhập ít nhất 1 giá (Xe khách hoặc Limousine).", "danger");
        return;
      }

      // check duplicate code (add new OR changing code in edit)
      const duplicate = routes.some(r => normalizeCode(r.code) === code && r.id !== editingId);
      if (duplicate){
        toast("Trùng mã tuyến", "Mã tuyến đã tồn tại. Hãy dùng mã khác.", "danger");
        return;
      }

      if (editingId){
        const idx = routes.findIndex(r => r.id === editingId);
        if (idx >= 0){
          routes[idx] = { ...routes[idx], code, status, from, to, priceBus, priceLimo, note };
          saveRoutesToLS(routes);
          closeModal("routeModal");
          toast("Cập nhật thành công", `Đã cập nhật tuyến ${from} - ${to}.`, "success");
          applyFilters();
        }
      } else {
        const newRoute = { id: uid(), code, status, from, to, priceBus, priceLimo, note };
        routes.unshift(newRoute);
        saveRoutesToLS(routes);
        closeModal("routeModal");
        toast("Thêm thành công", `Đã thêm tuyến ${from} - ${to}.`, "success");
        clearFilters();
      }
    }

    function askDelete(id){
      const r = routes.find(x => x.id === id);
      if (!r) return;
      document.getElementById("deleteId").value = id;
      document.getElementById("deleteName").textContent = `${r.from} - ${r.to} (${r.code})`;
      document.getElementById("deleteReason").value = "";
      openModal("deleteModal");
    }

    function confirmDelete(){
      const id = document.getElementById("deleteId").value;
      const reason = document.getElementById("deleteReason").value.trim();
      if (!reason){
        toast("Thiếu lý do", "Vui lòng nhập lý do xóa tuyến.", "danger");
        return;
      }

      const r = routes.find(x => x.id === id);
      if (!r){
        closeModal("deleteModal");
        toast("Không tìm thấy", "Tuyến không còn tồn tại.", "danger");
        return;
      }

      // 1) write log
      const logs = loadDeleteLogs();
      logs.unshift({
        deletedAt: nowISO(),
        routeId: r.id,
        routeCode: r.code,
        from: r.from,
        to: r.to,
        priceBus: r.priceBus,
        priceLimo: r.priceLimo,
        status: r.status,
        note: r.note || "",
        reason,
        deletedBy: CURRENT_USER.name,
        role: CURRENT_USER.role
      });
      saveDeleteLogs(logs);

      // 2) delete
      routes = routes.filter(x => x.id !== id);
      saveRoutesToLS(routes);

      closeModal("deleteModal");
      toast("Xóa thành công", `Đã xóa tuyến ${r.from} - ${r.to}.`, "success");
      applyFilters();
    }

    /* =========================
       5) DELETE LOG VIEW
       ========================= */
    function openLogModal(){
      document.getElementById("logQ").value = "";
      document.getElementById("logFrom").value = "";
      document.getElementById("logTo").value = "";
      renderDeleteLog();
      openModal("deleteLogModal");
    }

    function clearDeleteLogs(){
      localStorage.removeItem(LS_DELETE_LOG_KEY);
      renderDeleteLog();
      toast("Đã xóa log", "Toàn bộ log xóa tuyến đã được xóa (demo).", "info");
    }

    function clearLogFilters(){
      document.getElementById("logQ").value = "";
      document.getElementById("logFrom").value = "";
      document.getElementById("logTo").value = "";
      renderDeleteLog();
    }

    function renderDeleteLog(){
      const tbody = document.getElementById("logTbody");
      tbody.innerHTML = "";

      const q = (document.getElementById("logQ").value || "").trim().toLowerCase();
      const fromD = document.getElementById("logFrom").value || "";
      const toD = document.getElementById("logTo").value || "";

      const logs = loadDeleteLogs();

      const filtered = logs.filter(item => {
        const hay = `${item.routeCode} ${item.from} ${item.to} ${item.reason} ${item.deletedBy}`.toLowerCase();
        if (q && !hay.includes(q)) return false;

        const dOnly = isoDateOnly(item.deletedAt); // yyyy-mm-dd
        if (fromD && dOnly < fromD) return false;
        if (toD && dOnly > toD) return false;

        return true;
      });

      document.getElementById("logCountChip").innerHTML = `<i class="fas fa-database"></i> ${filtered.length} bản ghi`;

      if (!filtered.length){
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding:16px;">
              <div class="empty">Chưa có log xóa tuyến (hoặc không khớp bộ lọc).</div>
            </td>
          </tr>
        `;
        return;
      }

      filtered.forEach(item => {
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td style="white-space:nowrap;"><strong>${item.deletedAt}</strong></td>
            <td>${item.from} - ${item.to}</td>
            <td><strong>${item.routeCode}</strong></td>
            <td>${escapeHtml(item.reason)}</td>
            <td>${escapeHtml(item.deletedBy)} <span class="muted">(${escapeHtml(item.role || "—")})</span></td>
          </tr>
        `);
      });
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* =========================
       6) TOAST
       ========================= */
    function toast(title, desc, type="info"){
      const wrap = document.getElementById("toastWrap");
      const el = document.createElement("div");
      el.className = `toast ${type}`;
      el.innerHTML = `
        <i class="fas ${type==="success"?"fa-circle-check":type==="danger"?"fa-triangle-exclamation":"fa-circle-info"}"></i>
        <div>
          <div class="t-title">${title}</div>
          <div class="t-desc">${desc}</div>
        </div>
      `;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(-6px)"; }, 2600);
      setTimeout(()=>{ el.remove(); }, 3200);
    }

    /* =========================
       7) INIT
       ========================= */
    renderTable(routes);
  </script>
</body>
</html>
